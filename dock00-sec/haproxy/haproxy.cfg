global
  maxconn 2000

  # Logs vers syslog-ng container (port 514)
  log syslog:514 local0 info

  # Socket admin
  stats socket /tmp/haproxy.socket level admin expose-fd listeners

  # TLS
  tune.ssl.default-dh-param 2048

defaults
  log global
  mode http
  option httplog
  option http-keep-alive
  option dontlognull
  timeout connect 30s
  timeout client  30s
  timeout server  30s

# ----------------------------
# STATS (pour toi + exporter Prometheus)
# ----------------------------
listen stats
  bind :8404
  mode http
  stats enable
  stats uri /stats
  stats refresh 10s
  stats show-legends
  stats show-node
  stats auth ${HAPROXY_STATS_USER}:${HAPROXY_STATS_PASS}

# ----------------------------
# FE_HTTPS_PUBLIC (TLS termination)
# ----------------------------
frontend FE_HTTPS_PUBLIC
  bind :443 ssl alpn h2,http/1.1 strict-sni \
    no-sslv3 no-tlsv10 no-tlsv11 \
    crt-list /usr/local/etc/haproxy/crt-list.txt

  mode http
  maxconn 2000

  # Variables (comme ta conf pfSense)
  http-request set-var(txn.txnhost) hdr(host)
  http-request set-var(txn.txnpath) path

  # Refus domaines racine / wildcard (copie de ton comportement)
  acl acl_nina_root        var(txn.txnhost) -m str -i nina.fm
  acl acl_nina_wildcard    var(txn.txnhost) -m str -i *.nina.fm
  acl acl_zone_root        var(txn.txnhost) -m str -i zonelibre.live
  acl acl_zone_wildcard    var(txn.txnhost) -m str -i *.zonelibre.live

  # ACL hosts
  acl acl_vw_host          var(txn.txnhost) -m str -i secrets.zonelibre.live
  acl is_libretime_host    var(txn.txnhost) -m str -i libretime.nina.fm
  acl is_photos_host       var(txn.txnhost) -m str -i photos.zonelibre.live
  acl is_drive_host        var(txn.txnhost) -m str -i cloud.zonelibre.live
  acl is_cal_host          var(txn.txnhost) -m str -i cal.zonelibre.live
  acl is_card_host         var(txn.txnhost) -m str -i card.zonelibre.live
  acl is_note_host         var(txn.txnhost) -m str -i note.zonelibre.live
  acl is_files_host        var(txn.txnhost) -m str -i files.zonelibre.live
  acl is_pdf_host          var(txn.txnhost) -m str -i pdf.zonelibre.live
  acl is_monitoring_host   var(txn.txnhost) -m str -i monitoring.zonelibre.live

  # Proxy headers “propres”
  http-request set-header X-Forwarded-Proto https
  http-request set-header X-Forwarded-For %[src]
  http-request set-header X-Real-IP %[src]
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]

  # Routage
  use_backend be_vaultwarden_http   if acl_vw_host
  use_backend be_libretime          if is_libretime_host
  use_backend be_drive              if is_drive_host
  use_backend be_photos             if is_photos_host
  use_backend be_calendar           if is_cal_host
  use_backend be_card               if is_card_host
  use_backend be_filestation        if is_files_host
  use_backend be_note               if is_note_host
  use_backend be_monitoring         if is_monitoring_host
  use_backend be_pdf                if is_pdf_host

  # Refus racines/wildcards
  use_backend BE_DENY_ALL if acl_nina_root || acl_nina_wildcard || acl_zone_root || acl_zone_wildcard

  default_backend BE_DENY_ALL

# ----------------------------
# FE_HTTP_Cert_Renewal (ACME http-01 + redirect HTTPS)
# ----------------------------
frontend FE_HTTP_Cert_Renewal
  bind :80
  mode http

  http-request set-var(txn.txnhost) hdr(host)
  http-request set-var(txn.txnpath) path

  # normalisation Host
  http-request set-header Host %[req.hdr(Host),lower,field(1,:)]

  acl is_synology_host var(txn.txnhost) -m str -i \
    blackbox.zonelibre.live note.zonelibre.live photos.zonelibre.live cloud.zonelibre.live \
    files.zonelibre.live cal.zonelibre.live card.zonelibre.live data.zonelibre.live

  acl is_libretime_host var(txn.txnhost) -m str -i libretime.nina.fm

  acl is_known_host var(txn.txnhost) -m str -i \
    blackbox.zonelibre.live note.zonelibre.live photos.zonelibre.live cloud.zonelibre.live \
    files.zonelibre.live cal.zonelibre.live card.zonelibre.live data.zonelibre.live \
    libretime.nina.fm monitoring.zonelibre.live pdf.zonelibre.live secrets.zonelibre.live

  acl is_acme_challenge var(txn.txnpath) -m beg -i /.well-known/acme-challenge/

  # host connu : challenge -> backend; sinon deny + redirect
  http-request deny deny_status 403 if is_known_host !is_acme_challenge
  http-request redirect scheme https code 301 if is_known_host !is_acme_challenge

  use_backend be_acme_syno      if is_synology_host is_acme_challenge
  use_backend be_acme_libretime if is_libretime_host is_acme_challenge

  default_backend BE_DENY_ALL

# ----------------------------
# BACKENDS (copie fidèle de ton pfSense)
# ----------------------------
backend be_vaultwarden_http
  mode http
  option httpchk
  http-check send meth OPTIONS
  retries 3
  timeout connect 30s
  timeout server  30s
  timeout tunnel 1h

  # WebSockets: ne pas forcer, seulement si demandé
  acl ws_upgrade hdr(Upgrade) -i websocket
  http-request set-header Connection "upgrade" if ws_upgrade
  http-request set-header Upgrade "websocket"  if ws_upgrade

  server vw_http 172.16.70.11:11001 check inter 1000

backend be_libretime
  mode http
  option httpchk
  http-check send meth GET uri /
  retries 3
  timeout connect 30s
  timeout server  30s
  timeout tunnel 1h
  option http-server-close

  http-request set-header Host %[req.hdr(Host)]
  acl is_websocket_upgrade hdr(Upgrade) -i websocket
  use-server srv_libretime if is_websocket_upgrade

  server srv_libretime 172.16.20.2:8080 check inter 1000

backend be_drive
  mode http
  retries 3
  timeout connect 30s
  timeout server  1800s
  timeout tunnel 1h
  option http-server-close

  http-request set-header Host cloud.zonelibre.live
  server blackbox 172.16.70.3:555 ssl verify none

backend be_photos
  mode http
  retries 3
  timeout connect 30s
  timeout server  1800s
  timeout tunnel 1h
  option http-server-close

  http-request set-header Host photos.zonelibre.live
  server blackbox 172.16.70.3:333 ssl verify none

backend be_calendar
  mode http
  retries 3
  timeout connect 30s
  timeout server  600s
  timeout tunnel 1h
  option http-server-close

  http-request set-header Host cal.zonelibre.live
  server blackbox 172.16.70.3:777 ssl verify none

backend be_card
  mode http
  retries 3
  timeout connect 30s
  timeout server  600s

  http-request set-header Host card.zonelibre.live
  server blackbox 172.16.70.3:888 ssl verify none

backend be_filestation
  mode http
  retries 3
  timeout connect 30s
  timeout server  1800s
  timeout tunnel 1h
  option http-server-close

  http-request set-header Host files.zonelibre.live
  server blackbox 172.16.70.3:7001 ssl verify none

backend be_note
  mode http
  retries 3
  timeout connect 30s
  timeout server  1200s
  timeout tunnel 1h
  option http-server-close

  http-request set-header Host note.zonelibre.live
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]
  server blackbox 172.16.70.3:444 ssl verify none

backend be_monitoring
  mode http
  option httpchk
  http-check send meth GET uri /
  retries 3
  timeout connect 30s
  timeout server  30s
  timeout tunnel 1h
  option http-server-close

  acl is_websocket_upgrade hdr(Upgrade) -i websocket
  use-server dock02_grafana if is_websocket_upgrade

  server dock02_grafana 172.16.70.12:3000 check inter 1000

backend be_pdf
  mode http
  option httpchk
  http-check send meth GET uri /login
  retries 3
  timeout connect 30s
  timeout server  30s
  timeout tunnel 1h
  option http-server-close

  acl is_websocket_upgrade hdr(Upgrade) -i websocket
  use-server dock01_stirling_pdf if is_websocket_upgrade

  server dock01_stirling_pdf 172.16.70.11:8088 check inter 5000

backend BE_DENY_ALL
  mode http
  http-request deny status 403

backend be_acme_syno
  mode http
  timeout connect 30s
  timeout server  30s
  server blackbox 172.16.70.3:80

backend be_acme_libretime
  mode http
  timeout connect 30s
  timeout server  30s
  server NINA_LT 172.16.20.2:80